<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI í€´ì¦ˆ ìƒì„±ê¸°</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JSZip for PPTX parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- PDF.js for PDF parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/webfontworld/gmarket/GmarketSans.css');

        body {
            font-family: 'GmarketSans', sans-serif;
            background-color: #ffffff;
        }

        .quiz-card {
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }

        .quiz-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-full md:w-80 bg-gray-50 border-r border-gray-200 p-6 flex flex-col h-auto md:h-full overflow-y-auto z-10 shadow-md md:shadow-none">
        <div class="mb-8">
            <h1 class="text-2xl font-bold text-blue-600 mb-2">ğŸ“ AI í€´ì¦ˆ ìƒì„±ê¸°</h1>
            <p class="text-sm text-gray-500">ìˆ˜ì—… ìë£Œë¥¼ ì—…ë¡œë“œí•˜ë©´ Geminiê°€ í€´ì¦ˆë¥¼ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.</p>
        </div>

        <div class="space-y-6">
            <!-- API Key Input -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Gemini API Key</label>
                <input type="password" id="apiKey" placeholder="AIza..." 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                <p class="text-xs text-gray-500 mt-1">
                    * <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-500 underline">Google AI Studio</a>ì—ì„œ ë°œê¸‰ë°›ì€ í‚¤ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”. (Vertex AI í‚¤ ë¶ˆê°€)
                </p>
            </div>

            <hr class="border-gray-200">

            <!-- File Upload -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">í•™ìŠµ ìë£Œ ì—…ë¡œë“œ</label>
                <div class="relative border-2 border-dashed border-gray-300 rounded-lg p-6 hover:bg-gray-100 transition-colors text-center cursor-pointer" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept=".pdf,.pptx,.txt" class="hidden" onchange="handleFileSelect(event)">
                    <div id="fileLabel">
                        <span class="text-2xl block mb-2">ğŸ“‚</span>
                        <span class="text-sm text-gray-500">í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ<br>(PDF, PPTX, TXT)</span>
                    </div>
                </div>
                <p id="fileNameDisplay" class="text-sm text-blue-600 mt-2 font-medium hidden truncate"></p>
            </div>

            <!-- Generate Button -->
            <button id="generateBtn" onclick="startGeneration()" disabled
                class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors shadow-sm flex justify-center items-center gap-2">
                ğŸš€ í€´ì¦ˆ ìƒì„±í•˜ê¸°
            </button>

             <!-- CSV Download Button (Hidden initially) -->
             <button id="downloadBtn" onclick="downloadCSV()" class="hidden w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition-colors shadow-sm flex justify-center items-center gap-2 mt-4">
                ğŸ’¾ CSV ë‹¤ìš´ë¡œë“œ
            </button>
        </div>

        <div class="mt-auto pt-6 text-xs text-gray-400 text-center">
            Made with HTML5 & Gemini
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 bg-white p-4 md:p-8 overflow-y-auto h-full relative">
        
        <!-- Welcome Message / Empty State -->
        <div id="emptyState" class="h-full flex flex-col items-center justify-center text-gray-400">
            <div class="text-6xl mb-4">ğŸ‘‹</div>
            <p class="text-lg text-center">ì¢Œì¸¡ì—ì„œ <b>AI Studio API Key</b>ë¥¼ ì…ë ¥í•˜ê³ <br>íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ í€´ì¦ˆë¥¼ ìƒì„±í•´ë³´ì„¸ìš”.</p>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden absolute inset-0 bg-white/80 z-20 flex flex-col items-center justify-center">
            <div class="loader mb-4"></div>
            <p class="text-lg font-bold text-gray-700" id="loadingText">íŒŒì¼ ë¶„ì„ ì¤‘...</p>
        </div>

        <!-- Quiz Container -->
        <div id="quizContainer" class="max-w-4xl mx-auto space-y-6 pb-20 hidden">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">ğŸ§© ìƒì„±ëœ í€´ì¦ˆ</h2>
                <span id="quizCountBadge" class="bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full">0 ë¬¸ì œ</span>
            </div>
            
            <div id="quizList" class="space-y-6">
                <!-- Quizzes will be injected here -->
            </div>
        </div>

    </main>

    <!-- Scripts -->
    <script>
        // State
        let currentFile = null;
        let extractedText = "";
        let quizzes = [];

        // UI Helpers
        const getEl = (id) => document.getElementById(id);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            currentFile = file;
            getEl('fileNameDisplay').textContent = `ì„ íƒë¨: ${file.name}`;
            getEl('fileNameDisplay').classList.remove('hidden');
            getEl('fileLabel').innerHTML = '<span class="text-green-500 font-bold">âœ“ íŒŒì¼ ì¤€ë¹„ ì™„ë£Œ</span>';
            
            checkReady();
        }

        getEl('apiKey').addEventListener('input', checkReady);

        function checkReady() {
            const apiKey = getEl('apiKey').value.trim();
            const btn = getEl('generateBtn');
            btn.disabled = !(apiKey && currentFile);
        }

        // ----------------------------------------------------------------
        // Text Extraction Logic
        // ----------------------------------------------------------------
        async function extractText() {
            if (!currentFile) return null;

            const fileType = currentFile.name.split('.').pop().toLowerCase();
            
            try {
                if (fileType === 'txt') {
                    return await currentFile.text();
                } else if (fileType === 'pdf') {
                    return await extractPdf(currentFile);
                } else if (fileType === 'pptx') {
                    return await extractPptx(currentFile);
                } else {
                    alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. (pdf, pptx, txt ì§€ì›)');
                    return null;
                }
            } catch (error) {
                console.error(error);
                alert(`í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨: ${error.message}`);
                return null;
            }
        }

        async function extractPdf(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = "";

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + "\n";
            }
            return fullText;
        }

        async function extractPptx(file) {
            const zip = await JSZip.loadAsync(file);
            let fullText = "";
            
            // PPTX stores slides in ppt/slides/slide*.xml
            const slideFiles = Object.keys(zip.files).filter(name => 
                name.startsWith('ppt/slides/slide') && name.endsWith('.xml')
            );
            
            // Sort to ensure order (slide1, slide2...)
            slideFiles.sort((a, b) => {
                const numA = parseInt(a.match(/slide(\d+)\.xml/)[1]);
                const numB = parseInt(b.match(/slide(\d+)\.xml/)[1]);
                return numA - numB;
            });

            for (const filename of slideFiles) {
                const content = await zip.file(filename).async("string");
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(content, "text/xml");
                const textNodes = xmlDoc.getElementsByTagName("a:t");
                
                let slideText = "";
                for(let i=0; i<textNodes.length; i++) {
                    slideText += textNodes[i].textContent + " ";
                }
                fullText += slideText + "\n";
            }
            return fullText;
        }

        // ----------------------------------------------------------------
        // Gemini API Logic
        // ----------------------------------------------------------------
        async function callGemini(prompt, isJsonArray = true) {
            const apiKey = getEl('apiKey').value.trim();
            
            // 1. ì²« ë²ˆì§¸ ì‹œë„: ìµœì‹  Flash ëª¨ë¸
            try {
                return await fetchGemini('gemini-1.5-flash', apiKey, prompt);
            } catch (error) {
                console.warn("1.5 Flash ì‹¤íŒ¨, 1.0 Pro ì‹œë„ ì¤‘...", error);
                
                // 404 ì—ëŸ¬ì¼ ê²½ìš°ì—ë§Œ ëª¨ë¸ì„ ë°”ê¿”ì„œ ì¬ì‹œë„
                if (error.message.includes('404')) {
                    try {
                        return await fetchGemini('gemini-pro', apiKey, prompt);
                    } catch (retryError) {
                        // ë‘ ë²ˆì§¸ë„ ì‹¤íŒ¨í•˜ë©´ ì—ëŸ¬ ë©”ì‹œì§€ êµ¬ì²´í™”
                        throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨ (404 Not Found).\n\n[í•´ê²°ì±…]\nì‚¬ìš©í•˜ì‹  í‚¤ê°€ 'Google AI Studio'ì—ì„œ ë°œê¸‰ëœ í‚¤ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.\n(Google Cloud Vertex AI í‚¤ëŠ” ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)`);
                    }
                } else {
                    throw error; // ë‹¤ë¥¸ ì—ëŸ¬(ê¶Œí•œ, íŒŒì‹± ë“±)ëŠ” ê·¸ëŒ€ë¡œ ë˜ì§
                }
            }
        }

        async function fetchGemini(modelName, apiKey, prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

            const requestBody = {
                contents: [{
                    parts: [{ text: prompt }]
                }]
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                // ì—ëŸ¬ ìƒì„¸ ì •ë³´ ì½ê¸°
                let errorMsg = `API Error: ${response.status}`;
                try {
                    const errorData = await response.json();
                    if(errorData.error && errorData.error.message) {
                        errorMsg += ` - ${errorData.error.message}`;
                    }
                } catch(e) {}
                
                throw new Error(errorMsg);
            }

            const data = await response.json();
            
            if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                throw new Error("AIê°€ ì‘ë‹µì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì•ˆì „ í•„í„° ë“± ì›ì¸)");
            }

            const text = data.candidates[0].content.parts[0].text;
            let cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
            
            try {
                return JSON.parse(cleanText);
            } catch (e) {
                console.error("JSON íŒŒì‹± ì‹¤íŒ¨", cleanText);
                throw new Error("AI ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        }

        // ----------------------------------------------------------------
        // Application Logic
        // ----------------------------------------------------------------
        async function startGeneration() {
            const loading = getEl('loadingIndicator');
            const loadingText = getEl('loadingText');
            
            loading.classList.remove('hidden');
            loadingText.textContent = "ë¬¸ì„œì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
